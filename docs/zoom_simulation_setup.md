# Zoom-In Simulation Setup Guide (2026-02-14)

Author: Juhan Kim

## 1. Overview

This document records the setup process for running a zoom-in cosmological simulation with star formation on a single node (64 cores, 1 TB memory).

### Goals
- Physical resolution: ~1 kpc (star formation visualization)
- Stable execution on 1 node (memory < 1 TB)
- AMR active only in zoom region, disabled in background region

### Final Results
- Stable execution through Main step 15+
- 29 stars formed (Level 12-14)
- Memory: 35.9 GB/proc (12 processes, ~430 GB total)
- AMR Level 14 reached (dx_phys ~ 0.9 kpc at z=0)

---

## 2. Simulation Design

### Box and Resolution
| Parameter | Value |
|-----------|-------|
| Box size | 10 h^-1 Mpc |
| levelmin | 7 (base grid: 128^3) |
| levelmax | 14 (dx ~ 0.9 kpc physical at z=0) |
| IC levels | 7-11 (generated by MUSIC) |
| Zoom region | 1.25 h^-1 Mpc cube (box center) |
| DM mass (finest) | ~8,759 h^-1 M_sun |

### Resolution Table
| Level | dx_comoving (h^-1 kpc) | dx_phys (kpc, z=0) | DM mass (h^-1 M_sun) |
|-------|----------------------|-------------------|---------------------|
| 7 | 78.1 | 115.4 | background (heavy) |
| 8 | 39.1 | 57.7 | background (heavy) |
| 9 | 19.5 | 28.9 | background (heavy) |
| 10 | 9.77 | 14.4 | background (heavy) |
| 11 | 4.88 | 7.22 | 8,759 (finest IC) |
| 12 | 2.44 | 3.61 | AMR only |
| 13 | 1.22 | 1.80 | AMR only |
| 14 | 0.61 | 0.90 | AMR only |

---

## 3. IC Generation (MUSIC)

### MUSIC Configuration File
- Path: `test_ksection/zoomin_10Mpc_lv11.conf`
- MUSIC binary: `/gpfs/kjhan/Darwin/Cudaization/MUSIC/build/MUSIC`

```
[setup]
boxlength       = 10          # Box size in Mpc/h
zstart          = 50          # Starting redshift
levelmin        = 7           # Base grid: 128^3
levelmax        = 11          # Zoom finest: 2048 effective
ref_center      = 0.5, 0.5, 0.5
ref_extent      = 0.1, 0.1, 0.1  # ~1.0 Mpc/h zoom region
baryons         = yes
use_2LPT        = yes

[cosmology]
Omega_m = 0.3111, Omega_L = 0.6889, Omega_b = 0.04
H0 = 67.66, sigma_8 = 0.8102, nspec = 0.9665

[random]
seed[7]  = 95064
seed[8]  = 31415
seed[9]  = 27182
seed[10] = 16180
seed[11] = 14142

[output]
format   = grafic2
filename = IC_zoomin_lv11
```

### Generated IC Structure
```
IC_zoomin_lv11/
  level_007/  (128x128x128, full box)
  level_008/  (66x66x66, zoom sub-region)
  level_009/  (96x96x96)
  level_010/  (152x152x152)
  level_011/  (256x256x256, finest zoom)
```

Each level directory contains:
`ic_deltab, ic_velbx/y/z, ic_poscx/y/z, ic_velcx/y/z, ic_pvar_00001, ic_refmap`

---

## 4. Key Problem: Background AMR Explosion

### Symptoms
With `ivar_refine=0` (quasi-Lagrangian), all cells in the background region are
refined from level 7 -> 8 -> 9 -> ..., growing exponentially and causing OOM crash.

### Root Cause
In the `.not. init` branch of `poisson_refine()` (amr/flag_utils.f90):
```fortran
if(.not. init) then
   do i=1,ncell
      ok(i)=ok(i).or.(cpu_map2(ind_cell(i))==1)
   end do
```
`cpu_map2` is set in `rho_fine` where `phi >= m_refine`, and since background
cells also contain particles, `cpu_map2=1` can be set for them as well.

### Attempted Solutions
| Attempt | Result |
|---------|--------|
| `sink_refine=.false.` | Insufficient -- cpu_map2 issue unresolved |
| `ngridtot=200M` (80M->200M) | Insufficient -- only delayed grid explosion |
| `ivar_refine=-1` (density-based) | Crash during init -- incompatible with IC structure |
| **`ivar_refine=11` + `ic_pvar_00006`** | **Success** |

---

## 5. Solution: Zoom Geometry Passive Scalar (HR5 Method)

### Principle
Method used in the HR5 simulation:
- Store zoom geometry information in the 6th passive scalar (`ic_pvar_00006`)
- `ivar_refine=11` (NVAR=11: hydro 5 + passive 6)
- `var_cut_refine=0.01`: only cells with scalar > 0.01 are allowed to refine

### Refinement Decision Logic
```
In poisson_refine:
  init phase:    uold(cell, 11) / uold(cell, 1) > 0.01  -> refine
  runtime phase: cpu_map2(cell) == 1                      -> refine
                 (cpu_map2 is set by rho_fine after mass_cut_refine filtering)
```

- **Init phase**: Zoom cells are identified from the scalar value read from `ic_pvar_00006`
- **Runtime phase**: `mass_cut_refine` filters out heavy DM particles so that
  `cpu_map2` is only set to 1 in the zoom region

### Creating ic_pvar_00006
Script: `test_ksection/create_pvar006.py`

```python
# Level 7 (base): extract zoom mask from ic_refmap (0.2% = 4096/2097152 cells)
# Levels 8-11 (zoom): all cells = 1.0 (entire grid is zoom region)
```

| Level | Grid Size | Zoom Cell Fraction |
|-------|-----------|-------------------|
| 7 | 128^3 | 0.2% (4096 cells) |
| 8 | 66^3 | 100% |
| 9 | 96^3 | 100% |
| 10 | 152^3 | 100% |
| 11 | 256^3 | 100% |

### Key Logic in init_refine.f90
```fortran
! amr/init_refine.f90 line 31
if(ivar_refine==0) call init_refmap   ! NOT called when ivar_refine=11
```
When `ivar_refine=11`, `init_refmap` is not called -> `cpu_map2` remains 0 ->
refinement during init is determined solely by the scalar criterion.

---

## 6. Final Namelist

File: `test_ksection/run_zoomin_lv11/cosmo_zoomin_physics.nml`

### REFINE_PARAMS (Key Section)
```fortran
&REFINE_PARAMS
m_refine=11*8.
ivar_refine=11              ! passive scalar 6 = zoom geometry
var_cut_refine=0.01         ! scalar > 0.01 -> refine
interpol_var=1
interpol_type=0
sink_refine=.true.
mass_cut_refine=2.32831e-10 ! level 11 DM mass threshold
/
```

### Full Parameter Summary
| Parameter | Value | Description |
|-----------|-------|-------------|
| levelmin | 7 | Base grid 128^3 |
| levelmax | 14 | Max AMR level (dx ~ 0.9 kpc) |
| ngridtot | 200,000,000 | Total grid allocation |
| nparttot | 50,000,000 | Total particle allocation |
| ivar_refine | 11 | Zoom geometry scalar |
| var_cut_refine | 0.01 | Zoom scalar threshold |
| mass_cut_refine | 2.32831e-10 | Heavy DM filter (lmin=11) |
| ordering | ksection | K-section domain decomposition |
| memory_balance | .true. | Memory-based load balancing |
| nremap | 5 | Load balance frequency |
| nsubcycle | 1,1,1,1,2 | Fine level subcycling |

---

## 7. Execution Results

### Execution Environment
- 12 MPI processes (12 of 64 cores used)
- Run directory: `test_ksection/run_zoomin_lv11/`
- Binary: ramses3d built from `bin/`

### Grid Structure at Main Step 15
```
Level  7:   262,144 grids (base, full box)
Level  8:    59,348 grids (zoom only)
Level  9:   326,602 grids
Level 10: 2,057,638 grids
Level 11: 10,695,246 grids
Level 12:   112,139 grids (AMR)
Level 13:    14,211 grids (AMR)
Level 14:       729 grids (AMR, maximum level)
```

### Physics Results
- **Star formation**: 29 stars (Level 12: 12, Level 13: 8, Level 14: 9)
- **Energy conservation**: econs = -2.74E-03
- **Scale factor**: a = 0.0232 (z ~ 42)

### Performance
- Memory: 35.9 GB/proc (min/max: 35.5-35.9 GB)
- Grid utilization: 7.8% of ngridmax
- Performance: ~5 us/pt, ~39 s/coarse step
- Total runtime: 583s (Main step 15)

### Stability Verification
- No grid explosion: Level 8 stable at 59K (previously: exploded to 2.1M)
- No memory growth: 35.3 GB -> 35.9 GB (+0.6 GB over 15 steps)
- Morton mismatch: 0

---

## 8. mass_cut_refine Reference Values

Values used in the HR5 simulation (by IC finest level):

| IC finest level | mass_cut_refine |
|----------------|-----------------|
| 8 | 1.19209e-07 |
| 9 | 1.49012e-08 |
| 10 | 1.86265e-09 |
| 11 | 2.32831e-10 |
| 12 | 2.91038e-11 |
| 13 | 3.63798e-12 |

---

## 9. File Inventory

| File | Description |
|------|-------------|
| `test_ksection/zoomin_10Mpc_lv11.conf` | MUSIC IC generation config |
| `test_ksection/IC_zoomin_lv11/` | Generated ICs (levels 7-11) |
| `test_ksection/create_pvar006.py` | ic_pvar_00006 generation script |
| `test_ksection/run_zoomin_lv11/cosmo_zoomin_physics.nml` | RAMSES namelist |
| `test_ksection/run_zoomin_lv11/run_zoomin_lv11.log` | Execution log |

---

## 10. Problem Resolution Summary

1. **System crash diagnosis**: Previous run was terminated by abnormal system reboot (not a program bug)
2. **Simulation scale design**: Configured box=10 Mpc/h, IC levels 7-11 to fit on 1 node
3. **IC regeneration**: Generated ICs with MUSIC using ref_extent=0.1 (1 Mpc/h zoom region)
4. **Grid explosion problem**: With `ivar_refine=0`, entire background was refined -> OOM
5. **HR5 method applied**: Resolved with `ivar_refine=11` + `ic_pvar_00006` (zoom geometry scalar)
6. **Stable execution confirmed**: Main step 15+, 29 stars formed, memory 35.9 GB/proc
